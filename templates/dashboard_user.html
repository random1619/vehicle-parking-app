{% extends "base.html" %}

{% block title %}User Dashboard - Parking App{% endblock %}

{% block nav %}
{% include "partials/user_topbar.html" %}
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="content-wrap">
    <header class="page-header">
      <p class="breadcrumb">User / Dashboard</p>
      <h1 class="page-title">Parking Overview</h1>
      <p class="page-subtitle">Now supports holds, waitlist, scheduled bookings, invoices, and notifications.</p>
    </header>

    <section class="stats-grid">
      <article class="stat-card">
        <div class="stat-label">Active Bookings</div>
        <div class="stat-value">{{ bookings | selectattr('status', 'equalto', 'active') | list | length }}</div>
      </article>
      <article class="stat-card">
        <div class="stat-label">Scheduled Bookings</div>
        <div class="stat-value">{{ scheduled_bookings | length }}</div>
      </article>
      <article class="stat-card">
        <div class="stat-label">Waitlist Entries</div>
        <div class="stat-value">{{ waitlist_entries | length }}</div>
      </article>
    </section>

    <section class="card" style="margin-bottom: 20px;">
      <div class="table-toolbar">
        <h2 class="section-title">Upcoming Scheduled Bookings</h2>
        <button class="btn btn-secondary btn-sm js-density-toggle" data-target="#scheduledTableWrap">Compact Rows</button>
      </div>

      {% if scheduled_bookings %}
      <div class="table-wrap" id="scheduledTableWrap">
        <table class="ops-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Lot</th>
              <th>Vehicle</th>
              <th>Start Time</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for item in scheduled_bookings %}
            <tr>
              <td><span class="id-pill">#{{ item.id }}</span></td>
              <td>{{ item.lot.location_name }}</td>
              <td>{{ item.vehicle_no }}</td>
              <td>{{ item.requested_start.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ item.duration_hours }} hr</td>
              <td><span class="badge badge-neutral">{{ item.status }}</span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="notice">No scheduled bookings at the moment.</p>
      {% endif %}
    </section>

    <section class="card" style="margin-bottom: 20px;">
      <div class="table-toolbar">
        <h2 class="section-title">Waitlist</h2>
        <button class="btn btn-secondary btn-sm js-density-toggle" data-target="#waitlistTableWrap">Compact Rows</button>
      </div>

      {% if waitlist_entries %}
      <div class="table-wrap" id="waitlistTableWrap">
        <table class="ops-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Lot</th>
              <th>Vehicle</th>
              <th>Requested</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in waitlist_entries %}
            <tr>
              <td><span class="id-pill">#{{ entry.id }}</span></td>
              <td>{{ entry.lot.location_name }}</td>
              <td>{{ entry.vehicle_no }}</td>
              <td>{{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                <div class="row-actions-inline">
                  <form method="POST" action="{{ url_for('user.cancel_waitlist', entry_id=entry.id) }}">
                    <button type="submit" class="btn btn-secondary btn-sm">Cancel</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="notice">You are not currently in any waitlist queue.</p>
      {% endif %}
    </section>

    <section class="card" style="margin-bottom: 20px;">
      <div class="table-toolbar">
        <h2 class="section-title">Recent Parking History</h2>
        <button class="btn btn-secondary btn-sm js-density-toggle" data-target="#historyTableWrap">Compact Rows</button>
      </div>

      {% if bookings %}
      <div class="table-wrap" id="historyTableWrap">
        <table class="ops-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Location</th>
              <th>Vehicle</th>
              <th>Timestamp</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for booking in bookings %}
            <tr>
              <td><span class="id-pill">#{{ booking.id }}</span></td>
              <td>{{ booking.parking_lot.location_name }}</td>
              <td>{{ booking.vehicle_no }}</td>
              <td>{{ booking.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                {% if booking.status == 'active' %}
                <span class="badge badge-success">Active</span>
                {% else %}
                <span class="badge badge-neutral">Released</span>
                {% endif %}
              </td>
              <td>
                <div class="row-actions-inline">
                  {% if booking.status == 'active' %}
                  <a href="{{ url_for('user.release_booking', booking_id=booking.id) }}" class="btn btn-danger btn-sm">Release</a>
                  {% else %}
                  <button class="btn btn-secondary btn-sm" disabled>Released</button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <h2>No bookings yet</h2>
        <p>Book a lot below to start parking history.</p>
      </div>
      {% endif %}
    </section>

    <section>
      <div class="page-actions" style="margin-top: 0; margin-bottom: 14px;">
        <h2 class="section-title">Available Parking Lots</h2>
        <div class="status-legend" aria-label="Status Legend">
          <span class="legend-chip"><span class="legend-dot available"></span>Available</span>
          <span class="legend-chip"><span class="legend-dot occupied"></span>Occupied</span>
          <span class="legend-chip"><span class="legend-dot maintenance"></span>Maintenance</span>
          <span class="legend-chip"><span class="legend-dot held"></span>Held</span>
        </div>
      </div>

      <div class="simple-grid two" style="margin-bottom: 20px;">
        {% for lot in parking_lots %}
        {% set available_count = lot.bookable_spots %}
        {% set occupied_count = lot.total_slots - available_count %}
        {% set occupied_pct = ((occupied_count / lot.total_slots) * 100) if lot.total_slots > 0 else 0 %}
        <article class="card" style="padding: 18px;">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px; margin-bottom: 10px;">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">{{ lot.location_name }}</div>
              <div class="notice">{{ lot.address }}</div>
            </div>
            <span class="id-pill">#{{ lot.id }}</span>
          </div>

          <div class="simple-grid two" style="margin-bottom: 12px;">
            <div class="card-muted">
              <div class="notice" style="margin-bottom: 4px;">Price / Hour</div>
              <div class="price">{{ lot.price }}</div>
            </div>
            <div class="card-muted">
              <div class="notice" style="margin-bottom: 4px;">Bookable Now</div>
              <div>{{ available_count }} / {{ lot.total_slots }}</div>
              {% if lot.maintenance_count > 0 %}
              <div class="notice">{{ lot.maintenance_count }} in maintenance</div>
              {% endif %}
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <div class="occupancy-track" style="max-width: 100%;">
              <span class="occupancy-fill {% if occupied_count >= lot.total_slots and lot.total_slots > 0 %}full{% endif %}" style="display: block; width: {{ '%.0f'|format(occupied_pct) }}%;"></span>
            </div>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
            <span class="notice">{{ occupied_count }} occupied</span>
            <a href="{{ url_for('user.book_parking_lot', lot_id=lot.id) }}" class="btn {% if available_count > 0 %}btn-success{% else %}btn-secondary{% endif %} btn-sm">
              {% if available_count > 0 %}Book Now{% else %}Join Waitlist{% endif %}
            </a>
          </div>
        </article>
        {% else %}
        <div class="card empty-state" style="grid-column: 1 / -1;">
          <h2>No lots available</h2>
          <p>Check back later for open lots.</p>
        </div>
        {% endfor %}
      </div>
    </section>

    <section class="card">
      <div class="page-actions" style="margin-top: 0; margin-bottom: 12px;">
        <h2 class="section-title">Recent Notifications</h2>
        <a href="{{ url_for('user.notifications') }}" class="btn btn-secondary btn-sm">View All</a>
      </div>
      {% if recent_notifications %}
      <div class="info-list">
        {% for note in recent_notifications %}
        <div class="info-row">
          <div>
            <div style="font-weight: 600;">{{ note.subject or note.notification_type }}</div>
            <div class="notice">{{ note.message }}</div>
          </div>
          <span class="notice">{{ note.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="notice">No notifications yet.</p>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}
