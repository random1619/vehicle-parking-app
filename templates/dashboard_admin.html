{% extends "base.html" %}

{% block title %}Admin Dashboard - Parking Ops{% endblock %}

{% block content %}
<div class="ops-shell">
  {% include "partials/admin_sidebar.html" %}

  <main class="ops-main">
    <header class="page-header">
      <p class="breadcrumb">Operations / Parking Lots</p>
      <h1 class="page-title">Parking Lots</h1>
      <p class="page-subtitle">Monitor occupancy and manage lot settings.</p>

      <div class="page-actions">
        <h2 class="section-title">Live Lot Status</h2>
        <a href="{{ url_for('admin.add_lot') }}" class="btn btn-primary">Add New Lot</a>
      </div>
    </header>

    <section class="card">
      {% if parking_lots %}
      <div class="table-wrap">
        <table class="ops-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Location</th>
              <th>Occupancy</th>
              <th>Spots</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for lot in parking_lots %}
            {% set occupied_pct = ((lot['occupied_count'] / lot['total_slots']) * 100) if lot['total_slots'] > 0 else 0 %}
            <tr>
              <td>
                <span class="id-pill">#{{ lot['id'] }}</span>
              </td>
              <td>
                <div style="font-weight: 600; margin-bottom: 4px;">{{ lot['location_name'] }}</div>
                <div class="notice">{{ lot['total_slots'] }} total slots</div>
              </td>
              <td>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span class="count-pill">{{ lot['occupied_count'] }}/{{ lot['total_slots'] }}</span>
                  <span class="notice" style="text-transform: uppercase; letter-spacing: 0.05em;">occupied</span>
                </div>
                <div class="occupancy-track">
                  <span class="occupancy-fill {% if lot['occupied_count'] >= lot['total_slots'] and lot['total_slots'] > 0 %}full{% endif %}" style="display: block; width: {{ '%.0f'|format(occupied_pct) }}%;"></span>
                </div>
                <div class="notice" style="margin-top: 6px;">
                  Bookable now: {{ lot['bookable_count'] }}
                  {% if lot['maintenance_count'] > 0 %}| Maintenance: {{ lot['maintenance_count'] }}{% endif %}
                  {% if lot['held_count'] > 0 %}| Held: {{ lot['held_count'] }}{% endif %}
                </div>
              </td>
              <td>
                <div class="spot-grid" style="max-width: 260px;">
                  {% for spot in lot['spots'][:12] %}
                  <a href="{{ url_for('admin.view_spot', spot_id=spot.id) }}" class="spot-pill {% if spot.is_available %}available{% else %}occupied{% endif %}">
                    {{ spot.spot_number }}
                  </a>
                  {% endfor %}
                  {% if lot['spots'] | length > 12 %}
                  <span class="spot-pill neutral">+{{ lot['spots'] | length - 12 }}</span>
                  {% endif %}
                </div>
              </td>
              <td>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                  <a href="{{ url_for('admin.edit_lot', lot_id=lot['id']) }}" class="btn btn-secondary btn-sm">Edit</a>
                  <a href="{{ url_for('admin.delete_lot', lot_id=lot['id']) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this lot?')">Delete</a>
                </div>
                <div class="notice">Last updated <span class="js-last-updated"></span></div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <h2>No parking lots yet</h2>
        <p>Create your first lot to begin managing parking operations.</p>
        <a href="{{ url_for('admin.add_lot') }}" class="btn btn-primary">Add New Lot</a>
      </div>
      {% endif %}
    </section>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    const timestamp = new Intl.DateTimeFormat('en-US', {
      dateStyle: 'medium',
      timeStyle: 'short'
    }).format(new Date());

    document.querySelectorAll('.js-last-updated').forEach((node) => {
      node.textContent = timestamp;
    });
  }());
</script>
{% endblock %}
