{% extends "base.html" %}

{% block title %}Admin Search - Parking Ops{% endblock %}

{% block extra_head %}
<style>
  .search-form-grid {
    display: grid;
    grid-template-columns: 190px 1fr auto;
    gap: 14px;
    align-items: end;
  }

  @media (max-width: 768px) {
    .search-form-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="ops-shell">
  {% include "partials/admin_sidebar.html" %}

  <main class="ops-main">
    <header class="page-header">
      <p class="breadcrumb">Operations / Search</p>
      <h1 class="page-title">Search Parking Lots</h1>
      <p class="page-subtitle">Find lots by location or by user booking history.</p>
    </header>

    <section class="card" style="margin-bottom: 18px;">
      <form method="GET" action="{{ url_for('admin.admin_search') }}" class="search-form-grid">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="filter" class="form-label">Filter By</label>
          <select name="filter" id="filter" class="form-select">
            <option value="location" {% if request.args.get('filter') == 'location' %}selected{% endif %}>Location</option>
            <option value="user" {% if request.args.get('filter') == 'user' %}selected{% endif %}>User (Email/Name)</option>
          </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label for="query" class="form-label">Search Query</label>
          <input type="text" class="form-control" name="query" id="query" placeholder="Enter location, user email, or user name" value="{{ request.args.get('query', '') }}" required>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" style="opacity: 0;">Search</label>
          <button type="submit" class="btn btn-primary">Search</button>
        </div>
      </form>
    </section>

    {% if query %}
    <section class="card">
      <div class="page-actions" style="margin-top: 0; margin-bottom: 16px;">
        <h2 class="section-title">Search Results</h2>
        <div class="notice">
          {% if parking_lots %}
          Found {{ parking_lots | length }} lot{{ 's' if parking_lots | length != 1 else '' }}
          {% else %}
          No results found
          {% endif %}
        </div>
      </div>

      {% if parking_lots %}
      <div class="simple-grid two" style="gap: 16px;">
        {% for lot in parking_lots %}
        <article class="card" style="padding: 18px; box-shadow: none;">
          <div style="display: flex; justify-content: space-between; gap: 10px; align-items: start; margin-bottom: 12px;">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">{{ lot.location_name }}</div>
              <span class="id-pill">#{{ lot.id }}</span>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <a href="{{ url_for('admin.edit_lot', lot_id=lot.id) }}" class="btn btn-secondary btn-sm">Edit</a>
              <a href="{{ url_for('admin.delete_lot', lot_id=lot.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this lot?')">Delete</a>
            </div>
          </div>

          <div class="card-muted" style="margin-bottom: 12px;">
            <div class="notice" style="margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em;">
              {% if filter_by == 'user' %}
              Spots booked by matched user
              {% else %}
              Total occupancy
              {% endif %}
            </div>
            <div style="font-weight: 600;">
              {% if filter_by == 'user' %}
              {{ user_booked_slots_per_lot[lot.id] if lot.id in user_booked_slots_per_lot else 0 }} / {{ lot.total_slots }} spots
              {% else %}
              {{ lot_occupied_spots[lot.id] if lot.id in lot_occupied_spots else 0 }} / {{ lot.total_slots }} occupied
              {% endif %}
            </div>
          </div>

          <div>
            <div class="notice" style="margin-bottom: 8px;">Spot preview</div>
            <div class="spot-grid">
              {% for spot in lot.spots[:15] %}
              {% if spot.is_available %}
              <a href="{{ url_for('admin.view_spot', spot_id=spot.id) }}" class="spot-pill available" title="Available - {{ spot.spot_number }}">{{ spot.spot_number }}</a>
              {% else %}
              <a href="{{ url_for('admin.view_spot', spot_id=spot.id) }}" class="spot-pill {% if filter_by == 'user' and spot.id|string in user_booked_spot_ids %}neutral{% else %}occupied{% endif %}" title="{{ spot.spot_number }}">
                {{ spot.spot_number }}
              </a>
              {% endif %}
              {% endfor %}
              {% if lot.spots | length > 15 %}
              <span class="spot-pill neutral">+{{ lot.spots | length - 15 }}</span>
              {% endif %}
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <h2>No matching lots</h2>
        <p>Try another filter or a broader search phrase.</p>
      </div>
      {% endif %}
    </section>
    {% endif %}
  </main>
</div>
{% endblock %}
