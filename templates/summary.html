{% extends "base.html" %}

{% block title %}User Summary - Parking App{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block nav %}
{% include "partials/user_topbar.html" %}
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="content-wrap" style="max-width: 980px;">
    <header class="page-header">
      <p class="breadcrumb">User / Summary</p>
      <h1 class="page-title">Usage Summary</h1>
      <p class="page-subtitle">How frequently each lot has been used in your bookings.</p>
    </header>

    <section class="chart-card">
      <h2 class="chart-title">Bookings per Lot</h2>
      <p class="chart-meta" id="chartMeta">Loading data...</p>
      <div class="chart-wrap fixed">
        <div id="chartSkeleton" aria-hidden="true">
          <div class="skeleton bar" style="width: 40%;"></div>
          <div class="skeleton bar" style="width: 56%;"></div>
          <div class="skeleton bar" style="width: 28%;"></div>
          <div class="skeleton chart"></div>
        </div>
        <canvas id="usageChart" style="display: none;"></canvas>
        <div id="emptyState" class="empty-state" style="display:none;">
          <h2>No data yet</h2>
          <p>Make at least one booking to see this summary.</p>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  let usageChart;

  function setMeta(text) {
    const el = document.getElementById('chartMeta');
    if (el) el.textContent = text;
  }

  function toggleViews({ showSkeleton = false, showCanvas = false, showEmpty = false }) {
    const skeleton = document.getElementById('chartSkeleton');
    const empty = document.getElementById('emptyState');
    const canvas = document.getElementById('usageChart');

    if (skeleton) skeleton.style.display = showSkeleton ? 'block' : 'none';
    if (canvas) canvas.style.display = showCanvas ? 'block' : 'none';
    if (empty) empty.style.display = showEmpty ? 'block' : 'none';
  }

  async function drawChart() {
    toggleViews({ showSkeleton: true, showCanvas: false, showEmpty: false });

    try {
      const response = await fetch('/user/spot_summary_data');
      const data = await response.json();

      if (!Array.isArray(data) || data.length === 0) {
        setMeta('0 lots');
        toggleViews({ showSkeleton: false, showCanvas: false, showEmpty: true });
        return;
      }

      const labels = data.map((item) => item.spot);
      const usageCounts = data.map((item) => item.usage);

      setMeta(`${labels.length} lot${labels.length === 1 ? '' : 's'}`);
      toggleViews({ showSkeleton: false, showCanvas: true, showEmpty: false });

      if (usageChart) {
        usageChart.destroy();
      }

      usageChart = new Chart(document.getElementById('usageChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Total Bookings',
            data: usageCounts,
            backgroundColor: '#3B5BDB',
            borderRadius: 8,
            maxBarThickness: 48
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#6B7280' }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => ` ${ctx.raw} booking${ctx.raw === 1 ? '' : 's'}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#6B7280', precision: 0 },
              grid: { color: '#E5E7EB' }
            },
            x: {
              ticks: { color: '#6B7280' },
              grid: { display: false }
            }
          }
        }
      });
    } catch (error) {
      console.error('Chart error:', error);
      setMeta('Error');
      toggleViews({ showSkeleton: false, showCanvas: false, showEmpty: true });
      const empty = document.getElementById('emptyState');
      if (empty) {
        empty.innerHTML = '<h2>Could not load data</h2><p>Please try again.</p>';
      }
    }
  }

  drawChart();
</script>
{% endblock %}
