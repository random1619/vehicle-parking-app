{% extends "base.html" %}

{% block title %}Parking Spot Details - Parking Ops{% endblock %}

{% block content %}
<div class="ops-shell">
  {% include "partials/admin_sidebar.html" %}

  <main class="ops-main">
    <a href="{{ url_for('admin.dashboard') }}" class="back-link">Back to Dashboard</a>

    <header class="page-header">
      <p class="breadcrumb">Operations / Spots / {{ spot.spot_number }}</p>
      <h1 class="page-title">Spot {{ spot.spot_number }}</h1>
      <p class="page-subtitle">{{ spot.lot.location_name }}</p>
    </header>

    <section class="simple-grid two" style="margin-bottom: 16px;">
      <article class="card" style="padding: 18px;">
        <div class="info-list">
          <div class="info-row"><span class="info-label">Spot ID</span><span class="info-value">#{{ spot.id }}</span></div>
          <div class="info-row"><span class="info-label">Spot Number</span><span class="info-value">{{ spot.spot_number }}</span></div>
          <div class="info-row"><span class="info-label">Lot</span><span class="info-value">{{ spot.lot.location_name }}</span></div>
          <div class="info-row"><span class="info-label">Price per Hour</span><span class="info-value price">{{ spot.lot.price }}</span></div>
          <div class="info-row"><span class="info-label">Status</span><span class="badge {% if spot.is_available %}badge-success{% else %}badge-danger{% endif %}">{% if spot.is_available %}Available{% else %}Occupied{% endif %}</span></div>
        </div>
      </article>

      <article class="card" style="padding: 18px;">
        {% if booking and user %}
        <h2 class="section-title" style="font-size: 1rem; margin-bottom: 10px;">Current Booking</h2>
        <div class="info-list">
          <div class="info-row"><span class="info-label">Booking ID</span><span class="info-value">#{{ booking.id }}</span></div>
          <div class="info-row"><span class="info-label">User</span><span class="info-value">{{ user.full_name }}</span></div>
          <div class="info-row"><span class="info-label">Email</span><span class="info-value">{{ user.email }}</span></div>
          <div class="info-row"><span class="info-label">Vehicle</span><span class="info-value">{{ booking.vehicle_no }}</span></div>
          <div class="info-row"><span class="info-label">Check-in</span><span class="info-value">{{ booking.timestamp.strftime('%Y-%m-%d %H:%M') }}</span></div>
          <div class="info-row"><span class="info-label">Duration</span><span class="info-value">{{ duration_hours }} hour{{ 's' if duration_hours != 1 else '' }}</span></div>
          <div class="info-row"><span class="info-label">Current Cost</span><span class="info-value price">{{ total_cost }}</span></div>
        </div>
        {% else %}
        <h2 class="section-title" style="font-size: 1rem; margin-bottom: 10px;">No Active Booking</h2>
        <p class="notice">This spot is free and can be removed if needed.</p>
        {% endif %}
      </article>
    </section>

    <section class="card" style="margin-bottom: 16px;">
      <div class="page-actions" style="margin-top: 0; margin-bottom: 10px;">
        <h2 class="section-title" style="font-size: 1rem;">Maintenance Mode</h2>
      </div>

      {% if active_maintenance %}
      <div class="alert alert-warning">
        Active since {{ active_maintenance.starts_at.strftime('%Y-%m-%d %H:%M') }}.
        Reason: {{ active_maintenance.reason or 'Not specified' }}.
      </div>
      <form method="POST" action="{{ url_for('admin.stop_spot_maintenance', spot_id=spot.id) }}" style="max-width: 220px;">
        <button type="submit" class="btn btn-secondary">End Maintenance</button>
      </form>
      {% else %}
      <p class="notice" style="margin-bottom: 10px;">This spot is currently not in maintenance.</p>
      <form method="POST" action="{{ url_for('admin.start_spot_maintenance', spot_id=spot.id) }}">
        <div class="form-group">
          <label class="form-label" for="reason">Reason</label>
          <input id="reason" name="reason" type="text" class="form-control" placeholder="Routine maintenance">
        </div>
        <div style="max-width: 220px;">
          <button type="submit" class="btn btn-primary" {% if booking %}disabled{% endif %}>Start Maintenance</button>
        </div>
        {% if booking %}
        <p class="notice" style="margin-top: 8px;">Maintenance can only be started when no active booking exists.</p>
        {% endif %}
      </form>
      {% endif %}
    </section>

    <section class="card danger-zone" style="margin-bottom: 16px;">
      <h3>Danger Zone</h3>
      <p class="notice" style="margin-bottom: 12px;">Deleting a spot is permanent and affects lot capacity.</p>

      {% if booking and user %}
      <div class="alert alert-warning" style="margin-bottom: 12px;">This spot has an active booking and cannot be deleted.</div>
      <div class="form-actions" style="max-width: 360px;">
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Back</a>
        <button type="button" class="btn btn-danger" disabled>Delete Spot</button>
      </div>
      {% else %}
      <form method="POST" action="{{ url_for('admin.delete_spot', spot_id=spot.id) }}" style="max-width: 360px;">
        <div class="form-actions">
          <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Back</a>
          <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this parking spot?')">Delete Spot</button>
        </div>
      </form>
      {% endif %}
    </section>
  </main>
</div>
{% endblock %}
