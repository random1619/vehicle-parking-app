{% extends "base.html" %}

{% block title %}Admin Summary - Parking Ops{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="ops-shell">
  {% include "partials/admin_sidebar.html" %}

  <main class="ops-main">
    <header class="page-header">
      <p class="breadcrumb">Operations / Summary</p>
      <h1 class="page-title">Operational Summary</h1>
      <p class="page-subtitle">Revenue, occupancy and demand trends with export tools.</p>
      <div class="page-actions">
        <a href="{{ url_for('admin.export_bookings_csv') }}" class="btn btn-secondary btn-sm">Export Bookings CSV</a>
        <a href="{{ url_for('admin.export_invoices_csv') }}" class="btn btn-secondary btn-sm">Export Invoices CSV</a>
      </div>
    </header>

    <section class="split-grid" style="margin-bottom: 16px;">
      <article class="chart-card">
        <h2 class="chart-title">Revenue by Lot</h2>
        <p class="chart-meta">Estimated from bookings and lot pricing.</p>
        <div class="chart-wrap"><canvas id="donutChart"></canvas></div>
      </article>

      <article class="chart-card">
        <h2 class="chart-title">Available vs Occupied</h2>
        <p class="chart-meta">Current slot distribution per lot.</p>
        <div class="chart-wrap"><canvas id="barChart"></canvas></div>
      </article>
    </section>

    <section class="split-grid">
      <article class="chart-card">
        <h2 class="chart-title">Bookings by Hour (Last 7 Days)</h2>
        <p class="chart-meta">Useful for staffing and peak-hour planning.</p>
        <div class="chart-wrap"><canvas id="hourlyChart"></canvas></div>
      </article>

      <article class="chart-card">
        <h2 class="chart-title">Top Lots by Usage</h2>
        <p class="chart-meta">Ranking by booking volume with revenue indicator.</p>
        <div class="table-wrap">
          <table class="ops-table" id="topLotsTable">
            <thead>
              <tr>
                <th>Lot</th>
                <th>Bookings</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" class="notice">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
    </section>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const axisColor = '#6B7280';
  const gridColor = '#E5E7EB';

  function buildDonut() {
    fetch('/admin/lot_revenue_data')
      .then((response) => response.json())
      .then((data) => {
        new Chart(document.getElementById('donutChart').getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: data.map((item) => item.lot),
            datasets: [{
              label: 'Revenue',
              data: data.map((item) => item.revenue),
              backgroundColor: ['#3B5BDB', '#2F9E44', '#E03131', '#0EA5E9', '#F59E0B', '#14B8A6'],
              borderColor: '#FFFFFF',
              borderWidth: 2,
            }],
          },
          options: {
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: axisColor },
              },
            },
          },
        });
      })
      .catch((error) => console.error(error));
  }

  function buildOccupancyBar() {
    fetch('/admin/lot_occupancy_data')
      .then((response) => response.json())
      .then((data) => {
        new Chart(document.getElementById('barChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: data.map((item) => item.lot),
            datasets: [
              { label: 'Available', data: data.map((item) => item.available), backgroundColor: '#2F9E44' },
              { label: 'Occupied', data: data.map((item) => item.occupied), backgroundColor: '#E03131' },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: axisColor, precision: 0 },
                grid: { color: gridColor },
              },
              x: {
                ticks: { color: axisColor },
                grid: { display: false },
              },
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: axisColor },
              },
            },
          },
        });
      })
      .catch((error) => console.error(error));
  }

  function buildHourlyChart() {
    fetch('/admin/analytics/hourly_data')
      .then((response) => response.json())
      .then((data) => {
        new Chart(document.getElementById('hourlyChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: data.map((item) => item.hour),
            datasets: [{
              label: 'Bookings',
              data: data.map((item) => item.count),
              borderColor: '#3B5BDB',
              backgroundColor: 'rgba(59, 91, 219, 0.12)',
              fill: true,
              tension: 0.25,
            }],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: axisColor, precision: 0 },
                grid: { color: gridColor },
              },
              x: {
                ticks: { color: axisColor },
                grid: { display: false },
              },
            },
            plugins: {
              legend: {
                labels: { color: axisColor },
              },
            },
          },
        });
      })
      .catch((error) => console.error(error));
  }

  function buildTopLotsTable() {
    fetch('/admin/analytics/top_lots_data')
      .then((response) => response.json())
      .then((rows) => {
        const tbody = document.querySelector('#topLotsTable tbody');
        if (!tbody) return;

        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="3" class="notice">No data available.</td></tr>';
          return;
        }

        tbody.innerHTML = rows.map((item) => (
          `<tr>
            <td>${item.lot}</td>
            <td>${item.bookings}</td>
            <td>INR ${Number(item.revenue).toFixed(2)}</td>
          </tr>`
        )).join('');
      })
      .catch((error) => console.error(error));
  }

  buildDonut();
  buildOccupancyBar();
  buildHourlyChart();
  buildTopLotsTable();
</script>
{% endblock %}
